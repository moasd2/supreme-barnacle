name: Ultimate-Win10-CRD-Parallel-5

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    # Ù‡Ø°Ù‡ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªØ´ØºÙ„ 5 Ù†Ø³Ø® Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
    strategy:
      fail-fast: false
      matrix:
        job_id: [1, 2, 3, 4, 5]

    steps:
      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± ÙƒÙˆØ¯ CRD Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ¨
      # -----------------------------------------------------------
      - name: Select CRD Code based on Matrix ID
        shell: pwsh
        env:
          # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙƒÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù‡Ù†Ø§ Ù„ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯ Ù…Ù†Ù‡Ø§
          CODE_1: ${{ secrets.CRD_CODE }}
          CODE_2: ${{ secrets.CRD_CODE1 }}
          CODE_3: ${{ secrets.CRD_CODE2 }}
          CODE_4: ${{ secrets.CRD_CODE3 }}
          CODE_5: ${{ secrets.CRD_CODE4 }}
        run: |
          $id = ${{ matrix.job_id }}
          $selectedCode = ""
          
          if ($id -eq 1) { $selectedCode = $env:CODE_1 }
          elseif ($id -eq 2) { $selectedCode = $env:CODE_2 }
          elseif ($id -eq 3) { $selectedCode = $env:CODE_3 }
          elseif ($id -eq 4) { $selectedCode = $env:CODE_4 }
          elseif ($id -eq 5) { $selectedCode = $env:CODE_5 }
          
          if ([string]::IsNullOrWhiteSpace($selectedCode)) {
            Write-Error "CRD Code is empty for Job ID $id. Please check GitHub Secrets."
          }
          
          # Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
          echo "CURRENT_CRD_CODE=$selectedCode" >> $env:GITHUB_ENV
          Write-Host "âœ… Selected CRD Code for Job $id"

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 2: ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­ ÙƒØ±ÙˆÙ… ÙˆØ®Ø¯Ù…Ø© Ø§Ù„Ø±ÙŠÙ…ÙˆØª (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰)
      # -----------------------------------------------------------
      - name: Download and Install Chrome & CRD
        shell: pwsh
        run: |
          Write-Host "â¬‡ï¸ Downloading Chrome..."
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait
          
          Write-Host "â¬‡ï¸ Downloading CRD Host..."
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait
          Write-Host "âœ… Chrome & CRD Installed."

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 3: Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬Ù‡Ø§Ø²
      # -----------------------------------------------------------
      - name: Manage External Counter (Gist)
        shell: pwsh
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          $headers = @{ "Authorization" = "token $env:GIST_TOKEN"; "Accept" = "application/vnd.github.v3+json" }
          $url = "https://api.github.com/gists/$env:GIST_ID"
          $success = $false
          $retryCount = 0

          while (-not $success) {
              try {
                  $response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get -ErrorAction Stop
                  $currentCount = [int]$response.files."counter.txt".content
                  $newCount = $currentCount + 1
                  
                  $body = @{ files = @{ "counter.txt" = @{ content = [string]$newCount } } } | ConvertTo-Json -Depth 10
                  Invoke-RestMethod -Uri $url -Headers $headers -Method Patch -Body $body -ErrorAction Stop
                  
                  echo "DEVICE_NUM=$newCount" >> $env:GITHUB_ENV
                  $success = $true
              }
              catch {
                  $sleepTime = Get-Random -Minimum 2 -Maximum 10
                  Write-Host "âš ï¸ Conflict detected, retrying in $sleepTime seconds..."
                  Start-Sleep -Seconds $sleepTime
              }
          }

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 4: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±ÙŠÙ…ÙˆØª Ø¯ÙŠØ³ÙƒØªÙˆØ¨ (Ù‚Ø¨Ù„ Ø£ÙŠ ØªØ­Ù…ÙŠÙ„Ø§Øª Ø«Ù‚ÙŠÙ„Ø©)
      # -----------------------------------------------------------
      - name: Register and Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_PIN: ${{ secrets.CRD_PIN }}
          # Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
          CRD_CODE: ${{ env.CURRENT_CRD_CODE }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          $UniqueName = "${{ github.actor }}-Machine-${{ env.DEVICE_NUM }}"
          
          Write-Host "ğŸš€ ACTIVATING CRD NOW to prevent timeout..."
          Write-Host "Name: $UniqueName"
          
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="$UniqueName" --pin=$env:CRD_PIN

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 5: ØªØ«Ø¨ÙŠØª VirtualBox (ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø±ÙŠÙ…ÙˆØª Ø´ØºØ§Ù„)
      # -----------------------------------------------------------
      - name: Install VirtualBox 6.1.48
        shell: pwsh
        run: |
          $vboxUrl = "https://download.virtualbox.org/virtualbox/6.1.48/VirtualBox-6.1.48-159471-Win.exe"
          (New-Object System.Net.WebClient).DownloadFile($vboxUrl, "VirtualBox-Setup.exe")
          Start-Process -FilePath "VirtualBox-Setup.exe" -Args "--silent --ignore-reboot" -Wait

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 6: ØªØ­Ù…ÙŠÙ„ ÙˆÙÙƒ Ø¶ØºØ· Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ¨ÙŠØ± (Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø·ÙˆÙ„)
      # -----------------------------------------------------------
      - name: Download and Extract to DESKTOP
        shell: cmd
        run: |
          @echo off
          cd /d "%USERPROFILE%\Desktop"
          set "FILE_URL=https://huggingface.co/datasets/swelam100/rdp/resolve/main/win.zip"
          
          echo â¬‡ï¸ Downloading large file... (RDP is already active)
          curl -L -o BigFile.zip "%FILE_URL%"
          
          echo ğŸ“¦ Extracting files...
          7z x BigFile.zip -y
          del BigFile.zip
          echo âœ… Done!

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 7: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„Ø¨Ù‚Ø§Ø¡ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„
      # -----------------------------------------------------------
      - name: Success Message & Keep Alive
        shell: pwsh
        run: |
          $FinalName = "${{ github.actor }}-Machine-${{ env.DEVICE_NUM }}"
          Write-Host "âœ… DONE! Connect to: $FinalName"
          
          # Ø­Ù„Ù‚Ø© Ø§Ù„Ø¨Ù‚Ø§Ø¡ (Keep Alive)
          while ($true) { Start-Sleep -Seconds 300 }
